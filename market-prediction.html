<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KrushiAi - Smart Farmer Decision Portal</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: "Segoe UI", Arial, sans-serif; margin:0; background:#f4f9f4; color:#333; }
header { background:#2e7d32; color:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
header h1 { margin:0; font-size:24px; }
nav a { color:#fff; margin-left:20px; text-decoration:none; font-weight:bold; transition:0.3s; }
nav a:hover { opacity:0.8; }
nav a.active { text-decoration:underline; }
.container { max-width:1200px; margin:auto; padding:25px; }
h2 { margin-top:30px; color:#2e7d32; font-size:20px; border-left:5px solid #2e7d32; padding-left:10px; }
.card { background:#fff; border-radius:12px; padding:18px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; }
.card:hover { transform: translateY(-4px); box-shadow:0 6px 14px rgba(0,0,0,0.15); }
#map { height:400px; border-radius:12px; margin-top:15px; box-shadow:0 3px 8px rgba(0,0,0,0.2); }
.badge { padding:4px 8px; border-radius:6px; font-weight:bold; font-size:13px; margin-left:10px; color:#fff; }
.badge.safe { background:#4caf50; }
.badge.warning { background:#ff9800; }
.crop-form { background: linear-gradient(135deg, #f9fff9, #e8f5e9); padding:20px; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.form-group { display: flex; flex-direction: column; }
.form-group.full-width { grid-column: 1 / -1; }
.form-group label { font-weight: 600; margin-bottom: 6px; color: #2e7d32; }
.form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; transition: 0.2s; }
.form-group input:focus, .form-group select:focus { border-color: #2e7d32; box-shadow: 0 0 6px rgba(46,125,50,0.25); outline: none; }
.inline-inputs { display: flex; gap: 12px; }
.inline-inputs input { flex: 1; }
.form-action { grid-column: 1 / -1; margin-top: 10px; text-align: center; }
.form-action button { padding: 12px 18px; font-size: 16px; font-weight: bold; background: linear-gradient(135deg, #2e7d32, #1b5e20); color: #fff; border: none; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; transition: 0.3s; }
.form-action button:hover { background: linear-gradient(135deg, #43a047, #2e7d32); }
#storageCards, #bestMandis { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px; }
canvas { background:#fff; border-radius:12px; padding:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-top:15px; }
.center-card { display: flex; justify-content: center; }
</style>
</head>
<body>

<header>
<h1>ğŸŒ¾ KrushiAi - Smart Farmer Decision Portal</h1>
<nav><a href="#" class="active">Home</a></nav>
</header>

<div class="container">

<h2>ğŸ“‹ Crop & Farmer Details</h2>
<div class="center-card">
  <div class="card crop-form" style="width:100%; max-width:700px;">
    <form class="form-grid">
      <div class="form-group">
        <label for="cropSelect">ğŸŒ¾ Select Crop</label>
        <select id="cropSelect">
          <option value="Tomato">Tomato</option>
          <option value="Potato">Potato</option>
          <option value="Onion">Onion</option>
        </select>
      </div>
      <div class="form-group">
        <label for="quantity">âš– Quantity (kg)</label>
        <input type="number" id="quantity" value="100">
      </div>
      <div class="form-group full-width">
        <label>ğŸ“ Farmer Location</label>
        <div class="inline-inputs">
          <input type="number" id="farmerLat" placeholder="Latitude" value="19.05">
          <input type="number" id="farmerLon" placeholder="Longitude" value="73.85">
        </div>
      </div>
      <div class="form-group">
        <label for="ratePerKm">ğŸšš Transport Rate (â‚¹/km)</label>
        <input type="number" id="ratePerKm" value="10">
      </div>
      <div class="form-action">
        <button type="button" onclick="updatePortal()">ğŸš€ Show Recommendations</button>
      </div>
    </form>
  </div>
</div>

<h2>ğŸŒ¦ Weather Alerts</h2>
<div id="weatherAlerts"></div>

<h2>ğŸ“¦ Cold Storages (Nearest Highlighted)</h2>
<div id="storageCards"></div>

<h2>ğŸ’° Mandis (Nearest Highlighted + Best Suggestions)</h2>
<div id="bestMandis"></div>

<h2>ğŸ“ˆ Net Profit Chart - Best Day to Sell</h2>
<canvas id="profitChart" height="200"></canvas>

<h3>ğŸ—º Map - Farmer, Mandi & Cold Storage</h3>
<div id="map"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Data
const storages = [
  { name:"Mumbai Cold Storage 1", lat:19.080, lon:72.880, rate:20, crops:["Tomato","Onion"], address:"Andheri East, Mumbai" },
  { name:"Mumbai Cold Storage 2", lat:19.070, lon:72.875, rate:18, crops:["Potato","Tomato"], address:"Bandra, Mumbai" },
  { name:"Pune Cold Storage A", lat:18.525, lon:73.860, rate:22, crops:["Potato","Tomato"], address:"Shivajinagar, Pune" },
  { name:"Pune Cold Storage B", lat:18.515, lon:73.855, rate:25, crops:["Potato"], address:"Hadapsar, Pune" },
  { name:"Nashik Cold Storage X", lat:20.010, lon:73.795, rate:19, crops:["Onion"], address:"Satpur MIDC, Nashik" }
];
const mandis = [
  { name:"Mumbai Mandi", lat:19.075, lon:72.877, address:"Vashi APMC Market, Navi Mumbai",
    pricesForecast:{ Tomato:[22,24,23], Potato:[15,16,17], Onion:[30,32,31] } },
  { name:"Pune Mandi", lat:18.520, lon:73.855, address:"Market Yard, Pune",
    pricesForecast:{ Tomato:[21,22,23], Potato:[16,17,18], Onion:[28,29,30] } },
  { name:"Nashik Mandi", lat:20.011, lon:73.791, address:"Lasalgaon Mandi, Nashik",
    pricesForecast:{ Tomato:[20,21,22], Potato:[14,15,16], Onion:[32,34,33] } }
];

// Map
let map = L.map('map').setView([19.05,73.85], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

// Icons
const farmerIcon = L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/green-dot.png", iconSize:[32,32]});
const mandiIcon = L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/red-dot.png", iconSize:[32,32]});
const storageIcon = L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png", iconSize:[32,32]});
const bestComboIcon = L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/yellow-dot.png", iconSize:[32,32]});

// Chart
let profitChart;

// Utils
function distance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function showWeather(lat){
  const alertsDiv=document.getElementById("weatherAlerts");
  alertsDiv.innerHTML=lat>19?'<div class="card"><span class="badge warning">âš  Heavy rain expected</span><br>Protect your crops.</div>':'<div class="card"><span class="badge safe">ğŸŒ Sunny Weather</span><br>Good for harvest.</div>';
}
function getDateLabel(startDate,dayIndex){
  const date=new Date(startDate); date.setDate(date.getDate()+dayIndex);
  return date.toLocaleDateString('en-US',{ weekday:'long', month:'short', day:'numeric' });
}

// Main
function updatePortal(){
  const crop=document.getElementById("cropSelect").value;
  const qty=parseFloat(document.getElementById("quantity").value);
  const lat=parseFloat(document.getElementById("farmerLat").value);
  const lon=parseFloat(document.getElementById("farmerLon").value);
  const rate=parseFloat(document.getElementById("ratePerKm").value);
  showWeather(lat);

  let eligibleStorages=storages.filter(s=>s.crops.includes(crop));
  eligibleStorages.forEach(s=>s.dist=distance(lat,lon,s.lat,s.lon));
  eligibleStorages.sort((a,b)=>a.dist-b.dist);
  const nearestStorage=eligibleStorages[0];

  mandis.forEach(m=>m.dist=distance(lat,lon,m.lat,m.lon));
  mandis.sort((a,b)=>a.dist-b.dist);
  const nearestMandi=mandis[0];

  // Mandi suggestions & best combo
  let mandiSuggestions=[]; let chartData={}; const startDate=new Date();
  let bestCombo=null; let maxProfit=-Infinity;

  mandis.forEach(m=>{
    if(!(crop in m.pricesForecast)) return;
    let prices=m.pricesForecast[crop]; chartData[m.name]=[];
    let bestNet=-Infinity; let bestDayIndex=0; let bestStorage=null;

    prices.forEach((price,idx)=>{
      eligibleStorages.forEach(s=>{
        const transport=rate*s.dist; const storageCost=s.rate;
        const net=qty*price - transport - storageCost;
        chartData[m.name].push(net.toFixed(2));
        if(net>bestNet){ bestNet=net; bestDayIndex=idx; bestStorage=s; }
        if(net>maxProfit){ maxProfit=net; bestCombo={mandi:m,storage:s,dayIdx:idx}; }
      });
    });

    mandiSuggestions.push({
      name:m.name,
      bestDayLabel:getDateLabel(startDate,bestDayIndex),
      netProfit:bestNet,
      storage:bestStorage,
      dist:m.dist,
      address:m.address
    });
  });

  mandiSuggestions.sort((a,b)=>b.netProfit-a.netProfit);

  // Display Cold Storages
  const storageContainer=document.getElementById("storageCards");
  storageContainer.innerHTML="";
  eligibleStorages.forEach(s=>{
    storageContainer.innerHTML+=`<div class="card ${s===nearestStorage?"safe":"warning"}">
      <h4>${s.name} ${s===nearestStorage?'<span class="badge safe">Nearest</span>':''}</h4>
      ğŸ“ Distance: ${s.dist.toFixed(1)} km<br>
      ğŸ“¦ Address: ${s.address}<br>
      ğŸ’° Storage Rate: â‚¹${s.rate}/day
    </div>`;
  });

  // Display Mandis
  const bestMandisDiv=document.getElementById("bestMandis");
  bestMandisDiv.innerHTML="";
  mandiSuggestions.slice(0,3).forEach(m=>{
    bestMandisDiv.innerHTML+=`<div class="card ${m.dist===nearestMandi.dist?"safe":"warning"}">
      <h4>ğŸª ${m.name} ${m.dist===nearestMandi.dist?'<span class="badge safe">Nearest</span>':''}</h4>
      ğŸ“… Best Day: ${m.bestDayLabel}<br>
      ğŸ’° Net Profit: â‚¹${m.netProfit.toFixed(2)}<br>
      ğŸ“ Address: ${m.address}<br>
      ğŸ“ Distance: ${m.dist.toFixed(1)} km<br>
      ğŸ“¦ Suggested Storage: ${m.storage.name} (${m.storage.dist.toFixed(1)} km, â‚¹${m.storage.rate}/day)
    </div>`;
  });

  // Chart
  const ctx=document.getElementById("profitChart").getContext('2d');
  if(profitChart) profitChart.destroy();
  profitChart=new Chart(ctx,{
    type:'line',
    data:{
      labels: mandis[0].pricesForecast[crop].map((_,i)=>getDateLabel(startDate,i)),
      datasets:Object.keys(chartData).map((mandi,idx)=>({
        label:mandi, data:chartData[mandi], borderColor:['#e53935','#3949ab','#2e7d32'][idx],
        backgroundColor:'transparent', tension:0.3, borderWidth:2
      }))
    },
    options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{title:{display:true,text:'Net Profit (â‚¹)'}}}}
  });

  // Map
  markersLayer.clearLayers();
  L.marker([lat,lon],{icon:farmerIcon}).addTo(markersLayer).bindPopup("ğŸ‘¨â€ğŸŒ¾ Farmer Location");

  eligibleStorages.forEach(s=>{
    const icon=s===bestCombo.storage?bestComboIcon:storageIcon;
    L.marker([s.lat,s.lon],{icon:icon}).addTo(markersLayer).bindPopup("ğŸ“¦ "+s.name+"<br>ğŸ“ "+s.address+"<br>â‚¹"+s.rate+"/day");
  });

  mandis.forEach(m=>{
    const icon=m===bestCombo.mandi?bestComboIcon:mandiIcon;
    L.marker([m.lat,m.lon],{icon:icon}).addTo(markersLayer).bindPopup("ğŸª "+m.name+"<br>ğŸ“ "+m.address);
  });

  const allPoints=[[lat,lon]];
  eligibleStorages.forEach(s=>allPoints.push([s.lat,s.lon]));
  mandis.forEach(m=>allPoints.push([m.lat,m.lon]));
  map.fitBounds(L.latLngBounds(allPoints),{padding:[50,50]});
}
</script>
</body>
</html>
